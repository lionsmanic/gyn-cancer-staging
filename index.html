<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å©¦ç™Œè‡¨åºŠåˆ†æœŸè¼”åŠ©ç³»çµ±</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=DM+Sans:wght@300;400;500;600&display=swap');

  :root {
    --teal: #0d7377;
    --teal-light: #14a085;
    --teal-dark: #0a5568;
    --accent: #f0a500;
    --bg: #f4f7f9;
    --card: #ffffff;
    --text: #1a2633;
    --text-muted: #5a6a7a;
    --border: #dde3ea;
    --success: #1a9e6e;
    --warning: #d97706;
    --danger: #c0392b;
    --radius: 12px;
    --shadow: 0 4px 24px rgba(13,115,119,0.10);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Noto Sans TC', 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  /* HEADER */
  header {
    background: linear-gradient(135deg, var(--teal-dark) 0%, var(--teal) 60%, var(--teal-light) 100%);
    color: #fff;
    padding: 22px 32px 18px;
    display: flex;
    align-items: center;
    gap: 18px;
    box-shadow: 0 2px 16px rgba(10,85,104,0.18);
  }
  header .logo { font-size: 2rem; }
  header h1 { font-size: 1.45rem; font-weight: 700; letter-spacing: 0.5px; }
  header p { font-size: 0.82rem; opacity: 0.82; margin-top: 2px; font-weight: 300; }

  /* LAYOUT */
  .layout { display: flex; min-height: calc(100vh - 72px); }

  /* SIDEBAR */
  nav {
    width: 220px;
    background: #fff;
    border-right: 1px solid var(--border);
    padding: 20px 0;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  nav .nav-label {
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 1.5px;
    color: var(--text-muted);
    padding: 8px 20px 4px;
    text-transform: uppercase;
  }
  nav button {
    background: none;
    border: none;
    text-align: left;
    padding: 10px 20px;
    cursor: pointer;
    font-size: 0.86rem;
    color: var(--text-muted);
    font-family: inherit;
    border-left: 3px solid transparent;
    transition: all 0.18s;
    line-height: 1.4;
  }
  nav button:hover { background: #f0f5f5; color: var(--teal); }
  nav button.active {
    background: #e8f5f5;
    color: var(--teal-dark);
    font-weight: 600;
    border-left-color: var(--teal);
  }
  nav .nav-divider { height: 1px; background: var(--border); margin: 8px 16px; }

  /* MAIN CONTENT */
  main {
    flex: 1;
    padding: 28px 36px;
    overflow-y: auto;
  }

  .page { display: none; }
  .page.active { display: block; }

  .page-title {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--teal-dark);
    margin-bottom: 6px;
  }
  .page-sub {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-bottom: 24px;
  }

  /* CARDS */
  .card {
    background: var(--card);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    padding: 22px 24px;
    margin-bottom: 18px;
    box-shadow: var(--shadow);
  }
  .card h3 {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--teal);
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 7px;
  }

  /* FORM ELEMENTS */
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
  .form-group { margin-bottom: 14px; }
  label.field-label {
    display: block;
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 6px;
    letter-spacing: 0.2px;
  }
  select, input[type="text"], input[type="password"] {
    width: 100%;
    padding: 9px 12px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    font-size: 0.88rem;
    font-family: inherit;
    background: #f8fafc;
    color: var(--text);
    transition: border 0.15s;
    outline: none;
  }
  select:focus, input:focus { border-color: var(--teal); background: #fff; }

  /* RADIO/CHECKBOX */
  .radio-group, .check-group { display: flex; flex-direction: column; gap: 7px; }
  .radio-item, .check-item {
    display: flex;
    align-items: flex-start;
    gap: 9px;
    cursor: pointer;
    font-size: 0.86rem;
    line-height: 1.4;
  }
  .radio-item input, .check-item input { margin-top: 2px; accent-color: var(--teal); cursor: pointer; }

  /* BUTTON */
  .btn {
    background: var(--teal);
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 12px 28px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
    transition: background 0.15s, transform 0.1s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  .btn:hover { background: var(--teal-dark); transform: translateY(-1px); }
  .btn:active { transform: translateY(0); }
  .btn-full { width: 100%; justify-content: center; }

  /* RESULT BOX */
  .result-box {
    border-radius: var(--radius);
    padding: 18px 22px;
    margin-top: 18px;
    font-size: 1.05rem;
    font-weight: 600;
    display: none;
    animation: fadeIn 0.3s ease;
  }
  .result-box.show { display: block; }
  .result-success {
    background: #e6f9f2;
    border: 1.5px solid #6fcfa8;
    color: #0f6b4a;
  }
  .result-info {
    background: #eaf3ff;
    border: 1.5px solid #90b8ef;
    color: #1a4a8a;
    font-size: 0.9rem;
    font-weight: 400;
    margin-top: 10px;
    display: none;
  }
  .result-info.show { display: block; }

  @keyframes fadeIn { from { opacity:0; transform: translateY(6px); } to { opacity:1; transform: translateY(0); } }

  /* AI PAGE */
  .api-note {
    background: #fff8e1;
    border: 1.5px solid #f0c040;
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 0.83rem;
    color: #7a5a00;
    margin-bottom: 18px;
  }
  .upload-area {
    border: 2px dashed var(--teal);
    border-radius: var(--radius);
    background: #f0f9f9;
    padding: 36px 24px;
    text-align: center;
    cursor: pointer;
    transition: background 0.15s;
    position: relative;
  }
  .upload-area:hover { background: #e0f2f2; }
  .upload-area input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
  .upload-area .upload-icon { font-size: 2.5rem; margin-bottom: 10px; }
  .upload-area p { color: var(--text-muted); font-size: 0.88rem; }

  .preview-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-top: 14px;
  }
  .preview-item {
    position: relative;
    width: 100px;
    height: 100px;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid var(--border);
  }
  .preview-item img { width: 100%; height: 100%; object-fit: cover; }
  .preview-item .remove-btn {
    position: absolute;
    top: 3px; right: 3px;
    background: rgba(0,0,0,0.55);
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 20px; height: 20px;
    font-size: 0.7rem;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
  }

  /* AI RESULT */
  .ai-result {
    background: #fff;
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    padding: 20px 24px;
    margin-top: 18px;
    display: none;
    line-height: 1.7;
  }
  .ai-result.show { display: block; }
  .ai-result h3 { color: var(--teal-dark); margin-bottom: 12px; font-size: 1rem; }
  .ai-result p { font-size: 0.88rem; color: var(--text); margin-bottom: 8px; }
  .ai-result table { border-collapse: collapse; width: 100%; margin: 12px 0; font-size: 0.86rem; }
  .ai-result th { background: #e8f5f5; color: var(--teal-dark); padding: 8px 12px; text-align: left; border: 1px solid var(--border); }
  .ai-result td { padding: 7px 12px; border: 1px solid var(--border); }
  .ai-result tr:nth-child(even) td { background: #f8fafc; }

  .spinner {
    display: none;
    text-align: center;
    padding: 24px;
    color: var(--teal);
    font-size: 0.9rem;
  }
  .spinner.show { display: block; }
  .spinner::before {
    content: '';
    display: block;
    width: 36px;
    height: 36px;
    border: 3px solid #c0e0e0;
    border-top-color: var(--teal);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 12px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .settings-card {
    background: #f8fafc;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 18px 20px;
    margin-bottom: 18px;
  }
  .settings-card label { font-size: 0.85rem; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 8px; }

  /* RESPONSIVE */
  @media (max-width: 720px) {
    nav { display: none; }
    main { padding: 16px; }
    .form-grid { grid-template-columns: 1fr; }
    header h1 { font-size: 1.1rem; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">âš•ï¸</div>
  <div>
    <h1>å©¦ç™Œè‡¨åºŠåˆ†æœŸè¼”åŠ©ç³»çµ±</h1>
    <p>Integrated Gynecologic Oncology Staging Tool &nbsp;Â·&nbsp; FIGO &amp; AJCC TNM</p>
  </div>
</header>

<div class="layout">
  <nav>
    <div class="nav-label">åˆ†æœŸåˆ¤å®š</div>
    <button class="active" onclick="showPage('endometrial', this)">ğŸ“‹ å­å®®å…§è†œç™Œ</button>
    <button onclick="showPage('ovarian', this)">ğŸ”µ åµå·¢ç™Œ</button>
    <button onclick="showPage('cervical', this)">ğŸ”´ å­å®®é ¸ç™Œ</button>
    <button onclick="showPage('sarcoma', this)">ğŸŸ  å­å®®æƒ¡æ€§è‚‰ç˜¤</button>
    <button onclick="showPage('melanoma', this)">âš« å¤–é™°é»‘è‰²ç´ ç˜¤</button>
    <button onclick="showPage('vaginal', this)">ğŸŸ£ é™°é“ç™Œ</button>
    <button onclick="showPage('gtn', this)">ğŸŸ¡ GTN</button>
    <button onclick="showPage('vulvar', this)">ğŸŸ¤ å¤–é™°ç™Œ</button>
    <div class="nav-divider"></div>
    <div class="nav-label">AI è¼”åŠ©</div>
    <button onclick="showPage('ai', this)">ğŸ¤– AI æ™ºæ…§åˆ¤è®€</button>
  </nav>

  <main>

    <!-- ===== å­å®®å…§è†œç™Œ ===== -->
    <div class="page active" id="page-endometrial">
      <div class="page-title">å­å®®å…§è†œç™Œåˆ†æœŸ</div>
      <div class="page-sub">Endometrial Cancer Â· FIGO 2023 &amp; AJCC TNM</div>
      <div class="form-grid">
        <div class="card">
          <h3>ğŸ”¬ ç—…ç†ç‰¹å¾µ</h3>
          <div class="form-group">
            <label class="field-label">çµ„ç¹”å­¸å‹æ…‹</label>
            <div class="radio-group">
              <label class="radio-item"><input type="radio" name="ec_histo" value="nonaggressive" checked> éå…‡éšª (non-aggressive): Low grade G1/G2 endometrioid</label>
              <label class="radio-item"><input type="radio" name="ec_histo" value="aggressive"> å…‡éšª (aggressive): Serous, Clear cell, Undifferentiated, Carcinosarcoma, G3 endometrioid</label>
            </div>
          </div>
          <div class="form-group">
            <label class="field-label">å­å®®è‚Œå±¤ä¾µçŠ¯æ·±åº¦</label>
            <div class="radio-group">
              <label class="radio-item"><input type="radio" name="ec_myo" value="none" checked> ç„¡ä¾µçŠ¯</label>
              <label class="radio-item"><input type="radio" name="ec_myo" value="lt50"> &lt;50%</label>
              <label class="radio-item"><input type="radio" name="ec_myo" value="ge50"> â‰¥50%</label>
            </div>
          </div>
          <div class="form-group">
            <label class="field-label">è¡€ç®¡æˆ–æ·‹å·´ç®¡ä¾µçŠ¯ (LVSI)</label>
            <div class="radio-group">
              <label class="radio-item"><input type="radio" name="ec_lvsi" value="none" checked> ç„¡ä¾µçŠ¯</label>
              <label class="radio-item"><input type="radio" name="ec_lvsi" value="focal"> è¼•å¾®ä¾µçŠ¯ (focal)</label>
              <label class="radio-item"><input type="radio" name="ec_lvsi" value="extensive"> å¤§é‡ä¾µçŠ¯ (extensive, â‰¥5 vessels)</label>
            </div>
          </div>
          <div class="form-group">
            <label class="field-label">æ·‹å·´çµè½‰ç§»å¤§å°</label>
            <div class="radio-group">
              <label class="radio-item"><input type="radio" name="ec_ln" value="none" checked> ç„¡</label>
              <label class="radio-item"><input type="radio" name="ec_ln" value="micro"> å¾®è½‰ç§» (micrometastasis): 0.2â€“2 mm</label>
              <label class="radio-item"><input type="radio" name="ec_ln" value="macro"> å·¨è½‰ç§» (macrometastasis): &gt;2 mm</label>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>ğŸ“ ä¾µçŠ¯ç¯„åœ</h3>
          <div class="check-group">
            <label class="check-item"><input type="checkbox" id="ec_cervical"> å®®é ¸é–“è³ªä¾µçŠ¯</label>
            <label class="check-item"><input type="checkbox" id="ec_ovarian_tubal"> åµå·¢æˆ–è¼¸åµç®¡ä¾µçŠ¯</label>
            <label class="check-item"><input type="checkbox" id="ec_ovarian_limited"> åµå·¢è…«ç˜¤å–®å´ä¾·é™ç„¡ç ´è£‚</label>
            <label class="check-item"><input type="checkbox" id="ec_serosa"> æ¼¿è†œä¾µçŠ¯</label>
            <label class="check-item"><input type="checkbox" id="ec_vaginal"> é™°é“æˆ–å­å®®æ—ä¾µçŠ¯</label>
            <label class="check-item"><input type="checkbox" id="ec_pelvic_peri"> éª¨ç›†è…¹è†œä¾µçŠ¯</label>
            <label class="check-item"><input type="checkbox" id="ec_upper_abd"> éª¨ç›†ä»¥ä¸Šè…¹è…”è…¹è†œä¾µçŠ¯</label>
            <label class="check-item"><input type="checkbox" id="ec_bladder"> è†€èƒ±æˆ–è…¸é»è†œä¾µçŠ¯</label>
            <label class="check-item"><input type="checkbox" id="ec_distant"> é è™•è½‰ç§»ï¼ˆå«è…¹è…”å¤–æ·‹å·´çµã€è‚ºã€è‚ã€è…¦ã€éª¨ç­‰ï¼‰</label>
          </div>
          <h3 style="margin-top:16px;">ğŸ§¬ æ·‹å·´çµèˆ‡åˆ†å­ç‰¹å¾µ</h3>
          <div class="check-group">
            <label class="check-item"><input type="checkbox" id="ec_pelvic_ln"> éª¨ç›†æ·‹å·´çµè½‰ç§»</label>
            <label class="check-item"><input type="checkbox" id="ec_pa_ln"> ä¸»å‹•è„ˆæ—æ·‹å·´çµè½‰ç§»</label>
            <label class="check-item"><input type="checkbox" id="ec_pole"> POLE mutation</label>
            <label class="check-item"><input type="checkbox" id="ec_p53"> p53 abnormal</label>
          </div>
        </div>
      </div>
      <button class="btn btn-full" onclick="stageEndometrial()">âš¡ è¨ˆç®—åˆ†æœŸ</button>
      <div class="result-box result-success" id="ec_result"></div>
      <div class="result-box result-info" id="ec_tnm"></div>
    </div>

    <!-- ===== åµå·¢ç™Œ ===== -->
    <div class="page" id="page-ovarian">
      <div class="page-title">åµå·¢ç™Œåˆ†æœŸ</div>
      <div class="page-sub">Ovarian Cancer Â· FIGO 2014 &amp; AJCC TNM</div>
      <div class="card">
        <h3>ğŸ”· T åŸç™¼è…«ç˜¤</h3>
        <select id="ov_t">
          <option value="T1a">T1a â€“ å–®å´åµå·¢ã€è¼¸åµç®¡æœªç ´è£‚</option>
          <option value="T1b">T1b â€“ é›™å´åµå·¢ã€è¼¸åµç®¡æœªç ´è£‚</option>
          <option value="T1c1">T1c1 â€“ æ‰‹è¡“æ™‚è…«ç˜¤æº¢å‡º</option>
          <option value="T1c2">T1c2 â€“ è¡“å‰ç ´è£‚æˆ–è…«ç˜¤æ–¼åµå·¢/è¼¸åµç®¡è¡¨é¢</option>
          <option value="T1c3">T1c3 â€“ è…¹æ°´æˆ–è…¹è†œæ²–æ´—ç´°èƒå­¸é™½æ€§</option>
          <option value="T2a">T2a â€“ å­å®®æˆ–è¼¸åµç®¡è½‰ç§»</option>
          <option value="T2b">T2b â€“ å…¶ä»–éª¨ç›†çµ„ç¹”è½‰ç§»</option>
          <option value="T3a">T3a â€“ è…¹è…”é¡¯å¾®è½‰ç§»</option>
          <option value="T3b">T3b â€“ è…¹è…”è½‰ç§» â‰¤2 cm</option>
          <option value="T3c">T3c â€“ è…¹è…”è½‰ç§» &gt;2 cm</option>
        </select>
      </div>
      <div class="card">
        <h3>ğŸ”· N æ·‹å·´çµ</h3>
        <select id="ov_n">
          <option value="N0">N0 â€“ ç„¡æ·‹å·´çµè½‰ç§»</option>
          <option value="N1a">N1a â€“ è…¹è†œå¾Œæ·‹å·´çµè½‰ç§» â‰¤10 mm</option>
          <option value="N1b">N1b â€“ è…¹è†œå¾Œæ·‹å·´çµè½‰ç§» &gt;10 mm</option>
        </select>
      </div>
      <div class="card">
        <h3>ğŸ”· M é ç«¯è½‰ç§»</h3>
        <select id="ov_m">
          <option value="M0">M0 â€“ ç„¡é ç«¯è½‰ç§»</option>
          <option value="M1a">M1a â€“ èƒ¸æ°´ç´°èƒå­¸é™½æ€§</option>
          <option value="M1b">M1b â€“ è‚è„¾å¯¦è³ªæˆ–è…¹å¤–å™¨å®˜è½‰ç§»</option>
        </select>
      </div>
      <button class="btn btn-full" onclick="stageOvarian()">âš¡ è¨ˆç®—åˆ†æœŸ</button>
      <div class="result-box result-success" id="ov_result"></div>
      <div class="result-box result-info" id="ov_tnm"></div>
    </div>

    <!-- ===== å­å®®é ¸ç™Œ ===== -->
    <div class="page" id="page-cervical">
      <div class="page-title">å­å®®é ¸ç™Œåˆ†æœŸ</div>
      <div class="page-sub">Cervical Cancer Â· FIGO 2018 &amp; AJCC TNM</div>
      <div class="card">
        <h3>ğŸ”· T Stage</h3>
        <select id="cx_t">
          <option value="T1a1">T1a1: Stromal invasion &lt;3 mm</option>
          <option value="T1a2">T1a2: Stromal invasion 3â€“5 mm</option>
          <option value="T1b1">T1b1: Invasion â‰¥5 mm depth, &lt;2 cm dimension</option>
          <option value="T1b2">T1b2: Dimension 2â€“4 cm</option>
          <option value="T1b3">T1b3: Dimension â‰¥4 cm</option>
          <option value="T2a1">T2a1: Vaginal involvement &lt;4 cm</option>
          <option value="T2a2">T2a2: Vaginal involvement â‰¥4 cm</option>
          <option value="T2b">T2b: Parametrial invasion</option>
          <option value="T3a">T3a: Lower third vagina</option>
          <option value="T3b">T3b: Pelvic wall / hydronephrosis</option>
          <option value="T3c1">T3c1: Pelvic LN metastasis</option>
          <option value="T3c2">T3c2: Paraaortic LN metastasis</option>
          <option value="T4">T4: Beyond true pelvis or biopsy-proven bladder/rectum mucosal involvement</option>
        </select>
      </div>
      <div class="card">
        <h3>ğŸ”· N Stage</h3>
        <select id="cx_n">
          <option value="N0">N0: No regional LN metastasis</option>
          <option value="N0i">N0(i+): Isolated tumor cells â‰¤0.2 mm</option>
          <option value="N1">N1: Regional LN metastasis</option>
        </select>
      </div>
      <div class="card">
        <h3>ğŸ”· M Stage</h3>
        <select id="cx_m">
          <option value="M0">M0: No distant metastasis</option>
          <option value="M1">M1: Distant metastasis</option>
        </select>
      </div>
      <button class="btn btn-full" onclick="stageCervical()">âš¡ è¨ˆç®—åˆ†æœŸ</button>
      <div class="result-box result-success" id="cx_result"></div>
      <div class="result-box result-info" id="cx_tnm"></div>
    </div>

    <!-- ===== å­å®®æƒ¡æ€§è‚‰ç˜¤ ===== -->
    <div class="page" id="page-sarcoma">
      <div class="page-title">å­å®®æƒ¡æ€§è‚‰ç˜¤åˆ†æœŸ</div>
      <div class="page-sub">Uterine Sarcoma Â· FIGO &amp; AJCC TNM</div>
      <div class="card">
        <h3>ğŸ”¬ Sarcoma Type</h3>
        <div class="radio-group" id="sarc_type_group">
          <label class="radio-item"><input type="radio" name="sarc_type" value="LMS" checked onchange="updateSarcomaT()"> Leiomyosarcoma</label>
          <label class="radio-item"><input type="radio" name="sarc_type" value="ESS" onchange="updateSarcomaT()"> Endometrial Stromal Sarcoma</label>
          <label class="radio-item"><input type="radio" name="sarc_type" value="MAS" onchange="updateSarcomaT()"> MÃ¼llerian Adenosarcoma</label>
        </div>
      </div>
      <div class="card">
        <h3>ğŸ”· T Stage</h3>
        <select id="sarc_t"></select>
      </div>
      <div class="form-grid">
        <div class="card">
          <h3>ğŸ”· N Stage</h3>
          <select id="sarc_n">
            <option value="N0">N0: No regional LN metastasis</option>
            <option value="N1">N1: Regional LN metastasis</option>
          </select>
        </div>
        <div class="card">
          <h3>ğŸ”· M Stage</h3>
          <select id="sarc_m">
            <option value="M0">M0: No distant metastasis</option>
            <option value="M1">M1: Distant metastasis</option>
          </select>
        </div>
      </div>
      <button class="btn btn-full" onclick="stageSarcoma()">âš¡ è¨ˆç®—åˆ†æœŸ</button>
      <div class="result-box result-success" id="sarc_result"></div>
      <div class="result-box result-info" id="sarc_tnm"></div>
    </div>

    <!-- ===== å¤–é™°é»‘è‰²ç´ ç˜¤ ===== -->
    <div class="page" id="page-melanoma">
      <div class="page-title">å¤–é™°é»‘è‰²ç´ ç˜¤åˆ†æœŸ</div>
      <div class="page-sub">Vulvar Melanoma Â· AJCC 8th Edition</div>
      <div class="card">
        <h3>ğŸ”· T åˆ†é¡</h3>
        <select id="mel_t">
          <option value="Tis">Tis â€“ åŸä½ç™Œ</option>
          <option value="T1a">T1a â€“ è…«ç˜¤&lt;0.8mmï¼Œç„¡æ½°ç˜</option>
          <option value="T1b">T1b â€“ è…«ç˜¤&lt;0.8mmæœ‰æ½°ç˜ï¼Œæˆ–0.8â€“1.0mm</option>
          <option value="T2a">T2a â€“ è…«ç˜¤&gt;1.0â€“2.0mmï¼Œç„¡æ½°ç˜</option>
          <option value="T2b">T2b â€“ è…«ç˜¤&gt;1.0â€“2.0mmï¼Œæœ‰æ½°ç˜</option>
          <option value="T3a">T3a â€“ è…«ç˜¤&gt;2.0â€“4.0mmï¼Œç„¡æ½°ç˜</option>
          <option value="T3b">T3b â€“ è…«ç˜¤&gt;2.0â€“4.0mmï¼Œæœ‰æ½°ç˜</option>
          <option value="T4a">T4a â€“ è…«ç˜¤&gt;4.0mmï¼Œç„¡æ½°ç˜</option>
          <option value="T4b">T4b â€“ è…«ç˜¤&gt;4.0mmï¼Œæœ‰æ½°ç˜</option>
        </select>
      </div>
      <div class="card">
        <h3>ğŸ”· N åˆ†é¡</h3>
        <select id="mel_n">
          <option value="N0">N0 â€“ ç„¡å€åŸŸæ·‹å·´çµè½‰ç§»</option>
          <option value="N1a">N1a â€“ å–®ä¸€éš±åŒ¿æ€§è½‰ç§»æ·‹å·´çµ</option>
          <option value="N1b">N1b â€“ å–®ä¸€è‡¨åºŠåµæ¸¬æ·‹å·´çµ</option>
          <option value="N1c">N1c â€“ ç„¡æ·‹å·´çµä½†æœ‰è¡›æ˜Ÿ/å¾®è¡›æ˜Ÿè½‰ç§»</option>
          <option value="N2a">N2a â€“ 2â€“3å€‹éš±åŒ¿æ€§è½‰ç§»æ·‹å·´çµ</option>
          <option value="N2b">N2b â€“ 2â€“3å€‹ä¸­è‡³å°‘ä¸€å€‹è‡¨åºŠåµæ¸¬</option>
          <option value="N2c">N2c â€“ ä¸€å€‹è‡¨åºŠ/éš±åŒ¿æ€§æ·‹å·´çµä¸”æœ‰è¡›æ˜Ÿè½‰ç§»</option>
          <option value="N3a">N3a â€“ â‰¥4å€‹éš±åŒ¿æ€§è½‰ç§»æ·‹å·´çµ</option>
          <option value="N3b">N3b â€“ â‰¥4å€‹ä¸­è‡³å°‘ä¸€å€‹è‡¨åºŠåµæ¸¬</option>
          <option value="N3c">N3c â€“ â‰¥2å€‹è‡¨åºŠ/éš±åŒ¿æ€§æ·‹å·´çµæˆ–èåˆæ·‹å·´çµ</option>
        </select>
      </div>
      <div class="card">
        <h3>ğŸ”· M åˆ†é¡</h3>
        <select id="mel_m">
          <option value="M0">M0 â€“ ç„¡é è™•è½‰ç§»</option>
          <option value="M1a0">M1a(0) â€“ çš®è†š/è»Ÿçµ„ç¹”/éå€åŸŸæ·‹å·´çµï¼ŒLDHä¸å‡é«˜</option>
          <option value="M1a1">M1a(1) â€“ çš®è†š/è»Ÿçµ„ç¹”/éå€åŸŸæ·‹å·´çµï¼ŒLDHå‡é«˜</option>
          <option value="M1b0">M1b(0) â€“ è‚ºè½‰ç§»ï¼ŒLDHä¸å‡é«˜</option>
          <option value="M1b1">M1b(1) â€“ è‚ºè½‰ç§»ï¼ŒLDHå‡é«˜</option>
          <option value="M1c0">M1c(0) â€“ éä¸­æ¨å…§è‡Ÿå™¨å®˜è½‰ç§»ï¼ŒLDHä¸å‡é«˜</option>
          <option value="M1c1">M1c(1) â€“ éä¸­æ¨å…§è‡Ÿå™¨å®˜è½‰ç§»ï¼ŒLDHå‡é«˜</option>
          <option value="M1d0">M1d(0) â€“ ä¸­æ¨ç¥ç¶“ç³»çµ±è½‰ç§»ï¼ŒLDHæ­£å¸¸</option>
          <option value="M1d1">M1d(1) â€“ ä¸­æ¨ç¥ç¶“ç³»çµ±è½‰ç§»ï¼ŒLDHå‡é«˜</option>
        </select>
      </div>
      <button class="btn btn-full" onclick="stageMelanoma()">âš¡ è¨ˆç®—åˆ†æœŸ</button>
      <div class="result-box result-success" id="mel_result"></div>
      <div class="result-box result-info" id="mel_tnm"></div>
    </div>

    <!-- ===== é™°é“ç™Œ ===== -->
    <div class="page" id="page-vaginal">
      <div class="page-title">é™°é“ç™Œåˆ†æœŸ</div>
      <div class="page-sub">Vaginal Cancer Â· FIGO &amp; AJCC TNM</div>
      <div class="card">
        <h3>ğŸ”· T â€“ è…«ç˜¤å¤§å°èˆ‡ä¾µçŠ¯</h3>
        <select id="vag_t">
          <option value="T1a">T1a â€“ ä¾·é™æ–¼é™°é“ï¼Œæœ€å¤§ç›´å¾‘ â‰¤2.0 cm</option>
          <option value="T1b">T1b â€“ ä¾·é™æ–¼é™°é“ï¼Œæœ€å¤§ç›´å¾‘ &gt;2.0 cm</option>
          <option value="T2a">T2a â€“ ç©¿é€é™°é“å£ä½†æœªé”éª¨ç›†å£ï¼Œç›´å¾‘ â‰¤2.0 cm</option>
          <option value="T2b">T2b â€“ ç©¿é€é™°é“å£ä½†æœªé”éª¨ç›†å£ï¼Œç›´å¾‘ &gt;2.0 cm</option>
          <option value="T3">T3 â€“ å·²é”éª¨ç›†å£æˆ–å¼•èµ·è…ç©æ°´</option>
          <option value="T4">T4 â€“ ä¾µçŠ¯è†€èƒ±æˆ–ç›´è…¸ï¼Œæˆ–è¶…å‡ºéª¨ç›†è…”</option>
        </select>
      </div>
      <div class="card">
        <h3>ğŸ”· N â€“ æ·‹å·´çµ</h3>
        <select id="vag_n">
          <option value="N0">N0 â€“ ç„¡å€åŸŸæ·‹å·´çµè½‰ç§»</option>
          <option value="N1">N1 â€“ éª¨ç›†æˆ–é¼ è¹Šå€æ·‹å·´çµè½‰ç§»</option>
        </select>
      </div>
      <div class="card">
        <h3>ğŸ”· M â€“ é è™•è½‰ç§»</h3>
        <select id="vag_m">
          <option value="M0">M0 â€“ ç„¡é è™•è½‰ç§»</option>
          <option value="M1">M1 â€“ æœ‰é è™•è½‰ç§»ï¼ˆè‚ºã€è‚ã€éª¨ï¼‰</option>
        </select>
      </div>
      <button class="btn btn-full" onclick="stageVaginal()">âš¡ è¨ˆç®—åˆ†æœŸ</button>
      <div class="result-box result-success" id="vag_result"></div>
      <div class="result-box result-info" id="vag_tnm"></div>
    </div>

    <!-- ===== GTN ===== -->
    <div class="page" id="page-gtn">
      <div class="page-title">å¦Šå¨ æ»‹é¤Šå±¤ç´°èƒè…«ç˜¤åˆ†æœŸ</div>
      <div class="page-sub">GTN Â· FIGO &amp; WHO Risk Score</div>
      <div class="form-grid">
        <div class="card">
          <h3>ğŸ”· è§£å‰–åˆ†æœŸ</h3>
          <div class="form-group">
            <label class="field-label">T åˆ†é¡</label>
            <div class="radio-group">
              <label class="radio-item"><input type="radio" name="gtn_t" value="T1" checked> T1 â€“ è…«ç˜¤ä¾·é™æ–¼å­å®®</label>
              <label class="radio-item"><input type="radio" name="gtn_t" value="T2"> T2 â€“ è…«ç˜¤å»¶ä¼¸è‡³å…¶ä»–ç”Ÿæ®–å™¨å®˜</label>
            </div>
          </div>
          <div class="form-group">
            <label class="field-label">M åˆ†é¡</label>
            <div class="radio-group">
              <label class="radio-item"><input type="radio" name="gtn_m" value="M0" checked> M0 â€“ ç„¡é è™•è½‰ç§»</label>
              <label class="radio-item"><input type="radio" name="gtn_m" value="M1a"> M1a â€“ è‚ºè½‰ç§»</label>
              <label class="radio-item"><input type="radio" name="gtn_m" value="M1b"> M1b â€“ å…¶ä»–é è™•è½‰ç§»</label>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>âš ï¸ WHO é¢¨éšªè©•åˆ†</h3>
          <div class="form-group">
            <label class="field-label">å¹´é½¡</label>
            <select id="gtn_age"><option value="0">0 â€“ &lt;40 æ­²</option><option value="1">1 â€“ â‰¥40 æ­²</option></select>
          </div>
          <div class="form-group">
            <label class="field-label">å‰æ¬¡æ‡·å­•</label>
            <select id="gtn_preg"><option value="0">0 â€“ è‘¡è„èƒ</option><option value="1">1 â€“ æµç”¢</option><option value="2">2 â€“ è¶³æœˆå¦Šå¨ </option></select>
          </div>
          <div class="form-group">
            <label class="field-label">è·å‰æ¬¡å¦Šå¨ æ™‚é–“</label>
            <select id="gtn_interval"><option value="0">0 â€“ &lt;4 å€‹æœˆ</option><option value="1">1 â€“ 4â€“6 å€‹æœˆ</option><option value="2">2 â€“ 7â€“12 å€‹æœˆ</option><option value="4">4 â€“ &gt;12 å€‹æœˆ</option></select>
          </div>
          <div class="form-group">
            <label class="field-label">æ²»ç™‚å‰ hCG (IU/mL)</label>
            <select id="gtn_hcg"><option value="0">0 â€“ &lt;10Â³</option><option value="1">1 â€“ 10Â³â€“10â´</option><option value="2">2 â€“ 10â´â€“10âµ</option><option value="4">4 â€“ â‰¥10âµ</option></select>
          </div>
          <div class="form-group">
            <label class="field-label">è…«ç˜¤æœ€å¤§ç›´å¾‘</label>
            <select id="gtn_size"><option value="0">0 â€“ &lt;3 cm</option><option value="1">1 â€“ 3â€“5 cm</option><option value="2">2 â€“ &gt;5 cm</option></select>
          </div>
          <div class="form-group">
            <label class="field-label">è½‰ç§»ä½ç½®</label>
            <select id="gtn_site"><option value="0">0 â€“ ç„¡æˆ–åƒ…è‚º</option><option value="1">1 â€“ è„¾è‡Ÿ/è…è‡Ÿ</option><option value="2">2 â€“ è…¸èƒƒé“</option><option value="4">4 â€“ è…¦/è‚è‡Ÿ</option></select>
          </div>
          <div class="form-group">
            <label class="field-label">è½‰ç§»ç—…ç¶æ•¸é‡</label>
            <select id="gtn_num"><option value="0">0 â€“ ç„¡</option><option value="1">1 â€“ 1â€“4 è™•</option><option value="2">2 â€“ 5â€“8 è™•</option><option value="4">4 â€“ &gt;8 è™•</option></select>
          </div>
          <div class="form-group">
            <label class="field-label">åŒ–ç™‚å¤±æ•—æ¬¡æ•¸</label>
            <select id="gtn_chemo"><option value="0">0 â€“ ç„¡</option><option value="2">2 â€“ å–®ä¸€è—¥ç‰©</option><option value="4">4 â€“ å…©ç¨®ä»¥ä¸Šè—¥ç‰©</option></select>
          </div>
        </div>
      </div>
      <button class="btn btn-full" onclick="stageGTN()">âš¡ è¨ˆç®—åˆ†æœŸèˆ‡é¢¨éšª</button>
      <div class="result-box result-success" id="gtn_result"></div>
      <div class="result-box result-info" id="gtn_score"></div>
    </div>

    <!-- ===== å¤–é™°ç™Œ ===== -->
    <div class="page" id="page-vulvar">
      <div class="page-title">å¤–é™°ç™Œåˆ†æœŸ</div>
      <div class="page-sub">Vulvar Cancer Â· FIGO 2021 &amp; AJCC TNM</div>
      <div class="card">
        <h3>ğŸ”· T åˆ†æœŸ</h3>
        <select id="vul_t">
          <option value="Tis">Tis â€“ åŸä½ç™Œ</option>
          <option value="T1a">T1a â€“ ç—…ç¶ â‰¤2 cmï¼Œæµ¸æ½¤æ·±åº¦ â‰¤1.0 mm</option>
          <option value="T1b">T1b â€“ ç—…ç¶ &gt;2 cm æˆ–æµ¸æ½¤æ·±åº¦ &gt;1.0 mm</option>
          <option value="T2">T2 â€“ å»¶ä¼¸è‡³é„°è¿‘æœƒé™°çµæ§‹ï¼ˆä¸‹1/3å°¿é“ã€ä¸‹1/3é™°é“æˆ–è‚›é–€ï¼‰</option>
          <option value="T3">T3 â€“ ä¾µçŠ¯ä¸Š2/3å°¿é“ã€ä¸Š2/3é™°é“ã€è†€èƒ±é»è†œã€ç›´è…¸é»è†œæˆ–å›ºå®šæ–¼éª¨ç›†éª¨</option>
        </select>
      </div>
      <div class="card">
        <h3>ğŸ”· N åˆ†æœŸ</h3>
        <select id="vul_n">
          <option value="N0">N0 â€“ ç„¡å€åŸŸæ·‹å·´çµè½‰ç§»</option>
          <option value="N1a">N1a â€“ 1æˆ–2å€‹æ·‹å·´çµè½‰ç§»ï¼Œå„ &lt;5 mm</option>
          <option value="N1b">N1b â€“ 1å€‹æ·‹å·´çµè½‰ç§» â‰¥5 mm</option>
          <option value="N2a">N2a â€“ â‰¥3å€‹æ·‹å·´çµè½‰ç§»ï¼Œå„ &lt;5 mm</option>
          <option value="N2b">N2b â€“ â‰¥2å€‹æ·‹å·´çµè½‰ç§» â‰¥5 mm</option>
          <option value="N2c">N2c â€“ æ·‹å·´çµè½‰ç§»ä¼´éš¨å¤–å›Šä¾µçŠ¯</option>
          <option value="N3">N3 â€“ å›ºå®šæˆ–æ½°ç˜æ€§æ·‹å·´çµè½‰ç§»</option>
        </select>
      </div>
      <div class="card">
        <h3>ğŸ”· M åˆ†æœŸ</h3>
        <select id="vul_m">
          <option value="M0">M0 â€“ ç„¡é è™•è½‰ç§»</option>
          <option value="M1">M1 â€“ æœ‰é è™•è½‰ç§»ï¼ˆå«éª¨ç›†æ·‹å·´çµè½‰ç§»ï¼‰</option>
        </select>
      </div>
      <button class="btn btn-full" onclick="stageVulvar()">âš¡ è¨ˆç®—åˆ†æœŸ</button>
      <div class="result-box result-success" id="vul_result"></div>
      <div class="result-box result-info" id="vul_tnm"></div>
    </div>

    <!-- ===== AI PAGE ===== -->
    <div class="page" id="page-ai">
      <div class="page-title">ğŸ¤– AI æ™ºæ…§åˆ¤è®€ (Beta)</div>
      <div class="page-sub">ä¸Šå‚³ç—…ç†å ±å‘Šæˆ–å½±åƒå ±å‘Šï¼Œç”± Gemini AI è§£è®€ä¸¦åˆ¤å®šåˆ†æœŸ</div>

      <div class="api-note">
        âš ï¸ <strong>éš±ç§è­¦å‘Šï¼š</strong>è«‹å‹¿ä¸Šå‚³å«æœ‰çœŸå¯¦ç—…æ‚£å§“åã€èº«åˆ†è­‰è™Ÿç¢¼ç­‰å€‹äººè­˜åˆ¥è³‡æ–™çš„åœ–ç‰‡ã€‚æœ¬åŠŸèƒ½åƒ…ä¾›è‡¨åºŠè¼”åŠ©åƒè€ƒï¼Œæœ€çµ‚åˆ†æœŸæ‡‰ç”±é†«å¸«ç¢ºèªã€‚
      </div>

      <div class="settings-card">
        <label>ğŸ”‘ Gemini API Key</label>
        <input type="password" id="ai_apikey" placeholder="è«‹è¼¸å…¥ Google Gemini API Key...">
      </div>

      <div class="card">
        <h3>ğŸ©º ç™Œç—‡é¡å‹ä¸Šä¸‹æ–‡</h3>
        <select id="ai_context">
          <option value="å­å®®å…§è†œç™Œ">å­å®®å…§è†œç™Œ</option>
          <option value="åµå·¢ç™Œ">åµå·¢ç™Œ</option>
          <option value="å­å®®é ¸ç™Œ">å­å®®é ¸ç™Œ</option>
          <option value="å­å®®æƒ¡æ€§è‚‰ç˜¤">å­å®®æƒ¡æ€§è‚‰ç˜¤</option>
          <option value="å¤–é™°ç™Œ">å¤–é™°ç™Œ</option>
          <option value="é™°é“ç™Œ">é™°é“ç™Œ</option>
          <option value="GTN">å¦Šå¨ æ»‹é¤Šå±¤ç´°èƒè…«ç˜¤ (GTN)</option>
          <option value="è‡ªå‹•åˆ¤æ–·">è‡ªå‹•åˆ¤æ–·</option>
        </select>
      </div>

      <div class="card">
        <h3>ğŸ“„ ä¸Šå‚³ç—…ç†/å½±åƒå ±å‘Š</h3>
        <div class="upload-area" onclick="document.getElementById('ai_files').click()">
          <input type="file" id="ai_files" accept="image/png,image/jpg,image/jpeg" multiple onchange="previewImages(event)">
          <div class="upload-icon">ğŸ“</div>
          <p><strong>é»æ“Šé¸æ“‡åœ–ç‰‡</strong>ï¼Œæˆ–æ‹–æ›³è‡³æ­¤è™•</p>
          <p style="margin-top:6px;font-size:0.78rem;">æ”¯æ´ JPG / PNGï¼Œå¯å¤šå¼µä¸Šå‚³</p>
        </div>
        <div class="preview-grid" id="ai_preview"></div>
      </div>

      <button class="btn btn-full" onclick="runAI()">ğŸ”¬ é–‹å§‹ AI åˆ†æ</button>

      <div class="spinner" id="ai_spinner">AI æ­£åœ¨ä»”ç´°é–±è®€å ±å‘Šä¸¦é€²è¡Œåˆ†æœŸé‹ç®—...</div>
      <div class="ai-result" id="ai_result">
        <h3>ğŸ“‹ AI åˆ†æçµæœ <span style="font-weight:300;font-size:0.8em;color:var(--text-muted);">Gemini 2.5 Flash</span></h3>
        <div id="ai_result_body"></div>
      </div>
    </div>

  </main>
</div>

<script>
// ========================= NAVIGATION =========================
function showPage(id, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  btn.classList.add('active');
}

// ========================= HELPERS =========================
function showResult(elId, msg, info = null) {
  const el = document.getElementById(elId);
  el.textContent = 'âœ… ' + msg;
  el.className = 'result-box result-success show';
  if (info) {
    const infoEl = document.getElementById(elId.replace('result', 'tnm') || elId + '_info');
    if (infoEl) { infoEl.textContent = 'AJCC TNM: ' + info; infoEl.className = 'result-box result-info show'; }
  }
}
function showScore(elId, msg) {
  const el = document.getElementById(elId);
  el.textContent = msg;
  el.className = 'result-box result-info show';
}
function radioVal(name) { return document.querySelector(`input[name="${name}"]:checked`)?.value; }
function chk(id) { return document.getElementById(id)?.checked; }

// ========================= ENDOMETRIAL =========================
function stageEndometrial() {
  const histo = radioVal('ec_histo');
  const myo = radioVal('ec_myo');
  const lvsi = radioVal('ec_lvsi');
  const ln = radioVal('ec_ln');
  const aggressive = histo === 'aggressive';

  let T = 'T1a';
  if (myo === 'ge50') T = 'T1b';
  if (chk('ec_cervical')) T = 'T2';
  if (chk('ec_serosa') || chk('ec_ovarian_tubal') || chk('ec_ovarian_limited')) T = 'T3a';
  if (chk('ec_vaginal') || chk('ec_pelvic_peri')) T = 'T3b';
  if (chk('ec_bladder')) T = 'T4';

  let N = 'N0';
  if (chk('ec_pelvic_ln')) N = ln === 'micro' ? 'N1mi' : 'N1a';
  if (chk('ec_pa_ln')) N = ln === 'micro' ? 'N2mi' : 'N2a';

  let M = chk('ec_distant') ? 'M1' : 'M0';
  let result = '';
  const tnm = `${T} ${N} ${M}`;

  if (chk('ec_pole') && ['T1a','T1b','T2'].includes(T) && N==='N0' && M==='M0') result = 'Stage IAmPOLEmut';
  else if (chk('ec_p53') && ['T1a','T1b','T2'].includes(T) && N==='N0' && M==='M0') result = 'Stage IICmp53abn';
  else if (M==='M1') result = 'FIGO Stage 4C';
  else if (chk('ec_upper_abd')) result = 'FIGO Stage 4B';
  else if (T==='T4') result = 'FIGO Stage 4A';
  else if (N==='N2mi') result = 'FIGO Stage 3C2i';
  else if (N==='N2a') result = 'FIGO Stage 3C2ii';
  else if (N==='N1mi') result = 'FIGO Stage 3C1i';
  else if (N==='N1a') result = 'FIGO Stage 3C1ii';
  else if (chk('ec_serosa')) result = 'FIGO Stage 3A2';
  else if (chk('ec_ovarian_limited') && !aggressive && (myo==='none'||myo==='lt50') && lvsi!=='extensive') result = 'FIGO Stage 1A3';
  else if (chk('ec_ovarian_tubal') || chk('ec_ovarian_limited')) result = 'FIGO Stage 3A1';
  else if (chk('ec_vaginal') && !chk('ec_pelvic_peri')) result = 'FIGO Stage 3B1';
  else if (chk('ec_pelvic_peri')) result = 'FIGO Stage 3B2';
  else if (aggressive && myo !== 'none') result = 'FIGO Stage 2C';
  else if (chk('ec_cervical') && !aggressive) result = 'FIGO Stage 2A';
  else if (lvsi==='extensive' && !aggressive) result = 'FIGO Stage 2B';
  else if (!aggressive) {
    if (myo==='ge50') result = 'FIGO Stage 1B';
    else if (myo==='lt50') result = 'FIGO Stage 1A2';
    else result = 'FIGO Stage 1A1';
  } else if (aggressive && myo==='none') result = 'FIGO Stage 1C';
  else result = 'éœ€é€²ä¸€æ­¥è©•ä¼°';

  showResult('ec_result', result, tnm);
}

// ========================= OVARIAN =========================
function stageOvarian() {
  const T = document.getElementById('ov_t').value;
  const N = document.getElementById('ov_n').value;
  const M = document.getElementById('ov_m').value;
  let stage = 'æœªèƒ½åˆ†é¡';
  if (M==='M1a') stage = 'Stage IVA';
  else if (M==='M1b') stage = 'Stage IVB';
  else if (N==='N1a') stage = 'Stage IIIA1i';
  else if (N==='N1b') stage = 'Stage IIIA1ii';
  else if (T==='T3a') stage = 'Stage IIIA2';
  else if (T==='T3b') stage = 'Stage IIIB';
  else if (T==='T3c') stage = 'Stage IIIC';
  else if (T==='T2a') stage = 'Stage IIA';
  else if (T==='T2b') stage = 'Stage IIB';
  else if (T==='T1a') stage = 'Stage IA';
  else if (T==='T1b') stage = 'Stage IB';
  else if (T==='T1c1') stage = 'Stage IC1';
  else if (T==='T1c2') stage = 'Stage IC2';
  else if (T==='T1c3') stage = 'Stage IC3';
  showResult('ov_result', stage, `${T} ${N} ${M}`);
}

// ========================= CERVICAL =========================
function stageCervical() {
  const T = document.getElementById('cx_t').value;
  const N = document.getElementById('cx_n').value;
  const M = document.getElementById('cx_m').value;
  let figo = 'Cannot classify';
  if (T==='T4') figo = M==='M0' ? 'Stage IVA' : 'Stage IVB';
  else if (M==='M1') figo = 'Stage IVB';
  else if (N==='N1'||N==='N0i') figo = 'Stage IIIC';
  else {
    const map = {T1a1:'Stage IA1',T1a2:'Stage IA2',T1b1:'Stage IB1',T1b2:'Stage IB2',T1b3:'Stage IB3',
                 T2a1:'Stage IIA1',T2a2:'Stage IIA2',T2b:'Stage IIB',T3a:'Stage IIIA',T3b:'Stage IIIB',T3c1:'Stage IIIC1',T3c2:'Stage IIIC2'};
    figo = map[T] || 'Cannot classify';
  }
  showResult('cx_result', `FIGO: ${figo}`, `${T} ${N} ${M}`);
}

// ========================= SARCOMA =========================
const sarcomaOpts = {
  LMS: ['T1a (â‰¤5 cm)','T1b (>5 cm)','T2a (adnexa)','T2b (pelvic tissues)','T3a (one abdominal site)','T3b (>one abdominal site)','T4 (bladder/rectum)'],
  ESS: ['T1a (â‰¤5 cm)','T1b (>5 cm)','T2a (adnexa)','T2b (pelvic tissues)','T3a (one abdominal site)','T3b (>one abdominal site)','T4 (bladder/rectum)'],
  MAS: ['T1a (endometrium/endocervix)','T1b (â‰¤half myometrial invasion)','T1c (>half myometrial invasion)','T2a (adnexa)','T2b (pelvic tissues)','T3a (one abdominal site)','T3b (>one abdominal site)','T4 (bladder/rectum)']
};
const sarcomaStages = {
  LMS: {'T1a':'IA','T1b':'IB','T2a':'IIA','T2b':'IIB','T3a':'IIIA','T3b':'IIIB','T4':'IVA'},
  ESS: {'T1a':'IA','T1b':'IB','T2a':'IIA','T2b':'IIB','T3a':'IIIA','T3b':'IIIB','T4':'IVA'},
  MAS: {'T1a':'IA','T1b':'IB','T1c':'IC','T2a':'IIA','T2b':'IIB','T3a':'IIIA','T3b':'IIIB','T4':'IVA'}
};
function updateSarcomaT() {
  const type = radioVal('sarc_type');
  const sel = document.getElementById('sarc_t');
  sel.innerHTML = sarcomaOpts[type].map(o => `<option value="${o.split(' ')[0]}">${o}</option>`).join('');
}
updateSarcomaT();
function stageSarcoma() {
  const type = radioVal('sarc_type');
  const T = document.getElementById('sarc_t').value;
  const N = document.getElementById('sarc_n').value;
  const M = document.getElementById('sarc_m').value;
  let result = '';
  if (M==='M1') result = 'FIGO Stage IVB';
  else if (N==='N1') result = 'FIGO Stage IIIC';
  else result = 'FIGO Stage ' + (sarcomaStages[type][T] || 'N/A');
  showResult('sarc_result', result, `${T} ${N} ${M}`);
}

// ========================= MELANOMA =========================
function stageMelanoma() {
  const T = document.getElementById('mel_t').value;
  const N = document.getElementById('mel_n').value;
  const M = document.getElementById('mel_m').value;
  let stage = 'æœªåˆ†é¡';
  if (T==='Tis'&&N==='N0'&&M==='M0') stage='Stage 0';
  else if (T==='T1a'&&N==='N0'&&M==='M0') stage='Stage IA';
  else if ((T==='T1b'||T==='T2a')&&N==='N0'&&M==='M0') stage='Stage IB';
  else if ((T==='T2b'||T==='T3a')&&N==='N0'&&M==='M0') stage='Stage IIA';
  else if ((T==='T3b'||T==='T4a')&&N==='N0'&&M==='M0') stage='Stage IIB';
  else if (T==='T4b'&&N==='N0'&&M==='M0') stage='Stage IIC';
  else if (N!=='N0'&&M==='M0') stage='Stage III';
  else if (M!=='M0') stage='Stage IV';
  showResult('mel_result', `AJCC ${stage}`, `${T} ${N} ${M}`);
}

// ========================= VAGINAL =========================
function stageVaginal() {
  const T = document.getElementById('vag_t').value;
  const N = document.getElementById('vag_n').value;
  const M = document.getElementById('vag_m').value;
  let res = 'è³‡æ–™ä¸è¶³';
  if (M==='M1') res='FIGO Stage IVB';
  else if (T==='T4') res='FIGO Stage IVA';
  else if (T==='T3'&&N==='N0') res='FIGO Stage III';
  else if (N==='N1') res='FIGO Stage III';
  else if (T==='T2a'||T==='T2b') res='FIGO Stage II';
  else if (T==='T1a'||T==='T1b') res='FIGO Stage I';
  showResult('vag_result', res, `${T} ${N} ${M}`);
}

// ========================= GTN =========================
function stageGTN() {
  const T = radioVal('gtn_t');
  const M = radioVal('gtn_m');
  let stage = '';
  if (M==='M0') stage = T==='T1' ? 'FIGO Stage I' : 'FIGO Stage II';
  else if (M==='M1a') stage = 'FIGO Stage III';
  else stage = 'FIGO Stage IV';
  const ids = ['gtn_age','gtn_preg','gtn_interval','gtn_hcg','gtn_size','gtn_site','gtn_num','gtn_chemo'];
  const score = ids.reduce((s,id) => s + parseInt(document.getElementById(id).value), 0);
  const risk = score < 7 ? 'ä½é¢¨éšª (Low Risk)' : 'é«˜é¢¨éšª (High Risk)';
  showResult('gtn_result', stage, null);
  showScore('gtn_score', `âš ï¸ WHO é¢¨éšªåˆ†æ•¸ï¼š${score} â†’ ${risk}`);
}

// ========================= VULVAR =========================
function stageVulvar() {
  const T = document.getElementById('vul_t').value;
  const N = document.getElementById('vul_n').value;
  const M = document.getElementById('vul_m').value;
  const map = {
    'Tis,N0,M0':'Stage 0', 'T1a,N0,M0':'Stage IA', 'T1b,N0,M0':'Stage IB', 'T2,N0,M0':'Stage II'
  };
  const stageIIIA_N = ['N1a','N1b'];
  const stageIIIB_N = ['N2a','N2b'];
  let figo = '';
  if (M==='M1') figo='Stage IVB';
  else if (T==='T3') figo='Stage IVA';
  else if (N==='N3') figo='Stage IVA';
  else if (N==='N2c') figo='Stage IIIC';
  else if (stageIIIB_N.includes(N)) figo='Stage IIIB';
  else if (stageIIIA_N.includes(N)) figo='Stage IIIA';
  else figo = map[`${T},${N},${M}`] || 'æœªçŸ¥åˆ†æœŸ';
  showResult('vul_result', `FIGO ${figo}`, `${T} ${N} ${M}`);
}

// ========================= AI =========================
let uploadedFiles = [];

function previewImages(e) {
  const files = Array.from(e.target.files);
  uploadedFiles = uploadedFiles.concat(files);
  renderPreviews();
}

function renderPreviews() {
  const grid = document.getElementById('ai_preview');
  grid.innerHTML = '';
  uploadedFiles.forEach((f, i) => {
    const url = URL.createObjectURL(f);
    const div = document.createElement('div');
    div.className = 'preview-item';
    div.innerHTML = `<img src="${url}" alt="preview"><button class="remove-btn" onclick="removeFile(${i})">âœ•</button>`;
    grid.appendChild(div);
  });
}

function removeFile(i) {
  uploadedFiles.splice(i, 1);
  renderPreviews();
}

async function runAI() {
  const apiKey = document.getElementById('ai_apikey').value.trim();
  const context = document.getElementById('ai_context').value;

  if (!apiKey) { alert('è«‹å…ˆè¼¸å…¥ Gemini API Key'); return; }
  if (uploadedFiles.length === 0) { alert('è«‹è‡³å°‘ä¸Šå‚³ä¸€å¼µå ±å‘Šåœ–ç‰‡'); return; }

  document.getElementById('ai_spinner').className = 'spinner show';
  document.getElementById('ai_result').className = 'ai-result';

  try {
    const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å©¦ç§‘è…«ç˜¤ç§‘é†«å¸«ã€‚ç›®å‰çš„ç™Œç—‡é¡å‹ä¸Šä¸‹æ–‡ç‚ºï¼š${context}ã€‚
è«‹åˆ†æåœ–ç‰‡ä¸­çš„ç—…ç†å ±å‘Šï¼ŒåŸ·è¡Œä»¥ä¸‹ä»»å‹™ï¼š
1. æ‘˜è¦é—œéµç™¼ç¾ï¼šæå–è…«ç˜¤å¤§å° (Tumor size)ã€ä¾µçŠ¯æ·±åº¦ (Invasion depth)ã€æ·‹å·´çµç‹€æ…‹ (Lymph node status)ã€é ç«¯è½‰ç§» (Metastasis)ã€çµ„ç¹”å­¸å‹æ…‹ (Histology) ç­‰é—œéµè³‡è¨Šã€‚
2. åˆ¤å®šåˆ†æœŸï¼šæ ¹æ“šæœ€æ–° FIGO èˆ‡ AJCC TNM ç³»çµ±é€²è¡Œåˆ†æœŸåˆ¤å®šï¼Œä¸¦è©³ç´°èªªæ˜åˆ¤å®šç†ç”±ã€‚
3. ä»¥ Markdown è¡¨æ ¼åˆ—å‡º Tã€Nã€M çš„åˆ¤å®šçµæœã€‚
å¦‚è³‡è¨Šä¸è¶³ï¼Œè«‹èªªæ˜ç¼ºå°‘å“ªäº›é—œéµè³‡æ–™ã€‚
è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚`;

    const parts = [{ text: prompt }];

    for (const file of uploadedFiles) {
      const b64 = await toBase64(file);
      parts.push({ inline_data: { mime_type: file.type, data: b64 } });
    }

    const payload = { contents: [{ parts }] };
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
    const res = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const data = await res.json();

    document.getElementById('ai_spinner').className = 'spinner';

    if (res.ok) {
      const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || 'ç„¡æ³•è§£æ AI å›å‚³å…§å®¹';
      document.getElementById('ai_result_body').innerHTML = markdownToHTML(text);
      document.getElementById('ai_result').className = 'ai-result show';
    } else {
      alert(`API éŒ¯èª¤ (${res.status}): ${data?.error?.message || 'æœªçŸ¥éŒ¯èª¤'}`);
    }
  } catch (err) {
    document.getElementById('ai_spinner').className = 'spinner';
    alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + err.message);
  }
}

function toBase64(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result.split(',')[1]);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

function markdownToHTML(md) {
  return md
    .replace(/^### (.+)$/gm, '<h4 style="color:var(--teal-dark);margin:14px 0 6px;">$1</h4>')
    .replace(/^## (.+)$/gm, '<h3 style="color:var(--teal);margin:16px 0 8px;">$1</h3>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/^\|(.+)\|$/gm, (row) => {
      const cells = row.split('|').filter(c => c.trim() !== '');
      return '<tr>' + cells.map(c => `<td style="border:1px solid #dde3ea;padding:6px 10px;">${c.trim()}</td>`).join('') + '</tr>';
    })
    .replace(/(<tr>.*<\/tr>\n?)+/gs, (rows) => `<table style="border-collapse:collapse;width:100%;margin:10px 0;">${rows}</table>`)
    .replace(/^[-â€¢*] (.+)$/gm, '<li style="margin:3px 0;">$1</li>')
    .replace(/(<li.*<\/li>\n?)+/gs, (items) => `<ul style="padding-left:20px;margin:8px 0;">${items}</ul>`)
    .replace(/\n\n/g, '<br><br>')
    .replace(/\n/g, '<br>');
}
</script>
</body>
</html>
